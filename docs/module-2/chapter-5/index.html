<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-module-2/chapter-5" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Chapter 5: Lidar and Depth Sensing: Building Point Clouds | RoboAI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://engineerabdullahiqbal.github.io/roboailearner/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://engineerabdullahiqbal.github.io/roboailearner/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://engineerabdullahiqbal.github.io/roboailearner/docs/module-2/chapter-5"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 5: Lidar and Depth Sensing: Building Point Clouds | RoboAI"><meta data-rh="true" name="description" content="üéØ Objective"><meta data-rh="true" property="og:description" content="üéØ Objective"><link data-rh="true" rel="icon" href="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="><link data-rh="true" rel="canonical" href="https://engineerabdullahiqbal.github.io/roboailearner/docs/module-2/chapter-5"><link data-rh="true" rel="alternate" href="https://engineerabdullahiqbal.github.io/roboailearner/docs/module-2/chapter-5" hreflang="en"><link data-rh="true" rel="alternate" href="https://engineerabdullahiqbal.github.io/roboailearner/docs/module-2/chapter-5" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Chapter 5: Lidar and Depth Sensing: Building Point Clouds","item":"https://engineerabdullahiqbal.github.io/roboailearner/docs/module-2/chapter-5"}]}</script><link rel="alternate" type="application/rss+xml" href="/roboailearner/blog/rss.xml" title="RoboAI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/roboailearner/blog/atom.xml" title="RoboAI Atom Feed"><link rel="stylesheet" href="/roboailearner/assets/css/styles.3fa040d2.css">
<script src="/roboailearner/assets/js/runtime~main.6a321682.js" defer="defer"></script>
<script src="/roboailearner/assets/js/main.d4331d1e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"> <div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/roboailearner/"><b class="navbar__title text--truncate">RoboAI</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/roboailearner/docs/course-outline">Curriculum</a><a class="navbar__item navbar__link" href="/roboailearner/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/EngineerAbdullahIqbal/roboailearner" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/roboailearner/docs/course-outline"><span title="Physical AI &amp; Humanoid Robotics: Course Outline" class="linkLabel_WmDU">Physical AI &amp; Humanoid Robotics: Course Outline</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/roboailearner/docs/module-1/chapter-1"><span title="Module 1: Foundations of Physical AI &amp; ROS 2" class="categoryLinkLabel_W154">Module 1: Foundations of Physical AI &amp; ROS 2</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/roboailearner/docs/module-2/chapter-4"><span title="Module 2: Sensing and Perception for Humanoids" class="categoryLinkLabel_W154">Module 2: Sensing and Perception for Humanoids</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/roboailearner/docs/module-2/chapter-4"><span title="Chapter 4: Camera Systems and Image Processing in ROS 2" class="linkLabel_WmDU">Chapter 4: Camera Systems and Image Processing in ROS 2</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/roboailearner/docs/module-2/chapter-5"><span title="Chapter 5: Lidar and Depth Sensing: Building Point Clouds" class="linkLabel_WmDU">Chapter 5: Lidar and Depth Sensing: Building Point Clouds</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/roboailearner/docs/module-2/chapter-6"><span title="Chapter 6: Sensor Fusion: Combining Data for Robust Perception" class="linkLabel_WmDU">Chapter 6: Sensor Fusion: Combining Data for Robust Perception</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/roboailearner/docs/module-3/chapter-7"><span title="Module 3: Motion, Control, and Navigation" class="categoryLinkLabel_W154">Module 3: Motion, Control, and Navigation</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/roboailearner/docs/module-4/chapter-10"><span title="Module 4: Advanced Topics and Real-World Deployment" class="categoryLinkLabel_W154">Module 4: Advanced Topics and Real-World Deployment</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/roboailearner/docs/module-5/chapter-14-student-projects"><span title="Module 5: Capstone Projects" class="categoryLinkLabel_W154">Module 5: Capstone Projects</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/roboailearner/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Module 2: Sensing and Perception for Humanoids</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Chapter 5: Lidar and Depth Sensing: Building Point Clouds</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 5: Lidar and Depth Sensing: Building Point Clouds</h1></header>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-objective">üéØ Objective<a href="#-objective" class="hash-link" aria-label="Direct link to üéØ Objective" title="Direct link to üéØ Objective" translate="no">‚Äã</a></h3>
<p>This chapter will enable students to understand the fundamental principles of LiDAR and depth cameras, implement a ROS 2 node in Python to convert depth image data into a 3D point cloud, and critically analyze the sim-to-real challenges inherent in 3D sensing.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-theory-how-lidar-and-depth-cameras-see-the-world">üß† Theory: How Lidar and Depth Cameras See the World<a href="#-theory-how-lidar-and-depth-cameras-see-the-world" class="hash-link" aria-label="Direct link to üß† Theory: How Lidar and Depth Cameras See the World" title="Direct link to üß† Theory: How Lidar and Depth Cameras See the World" translate="no">‚Äã</a></h3>
<p>Robots navigate and interact with the physical world by perceiving it in three dimensions. LiDAR (Light Detection and Ranging) and depth cameras are crucial sensors for this task, each with distinct physical mechanisms and trade-offs.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="lidar-active-ranging-with-lasers">LiDAR: Active Ranging with Lasers<a href="#lidar-active-ranging-with-lasers" class="hash-link" aria-label="Direct link to LiDAR: Active Ranging with Lasers" title="Direct link to LiDAR: Active Ranging with Lasers" translate="no">‚Äã</a></h4>
<p>LiDAR systems measure distance by emitting pulsed laser light and calculating the time it takes for the light to return to the sensor (Time-of-Flight, ToF). By rotating or scanning, LiDAR builds a sparse, high-precision point cloud of the environment.</p>
<ul>
<li class=""><strong>Physical Context</strong>: LiDAR operates independently of ambient light (though direct sunlight can cause saturation). Its accuracy is generally high, but dense point clouds require fast-spinning mechanics, which introduce latency and potential mechanical failure points. The data rate for a typical 16-beam LiDAR can be significant, requiring efficient processing on edge devices.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="depth-cameras-inferring-distance-from-light">Depth Cameras: Inferring Distance from Light<a href="#depth-cameras-inferring-distance-from-light" class="hash-link" aria-label="Direct link to Depth Cameras: Inferring Distance from Light" title="Direct link to Depth Cameras: Inferring Distance from Light" translate="no">‚Äã</a></h4>
<p>Depth cameras leverage various principles to infer the distance to objects in their field of view:</p>
<ul>
<li class="">
<p><strong>Structured Light</strong>: Projects a known pattern (e.g., infrared dots or lines) onto the scene and calculates depth by analyzing the distortion of this pattern (e.g., Microsoft Kinect v1, Intel RealSense SR300).</p>
</li>
<li class="">
<p><strong>Stereo Vision</strong>: Uses two or more cameras to capture images from slightly different perspectives, then calculates depth by finding correspondences between pixels in the different images, similar to human binocular vision (e.g., ZED Camera, Intel RealSense D400 series).</p>
</li>
<li class="">
<p><strong>Time-of-Flight (ToF)</strong>: Emits modulated infrared light and measures the phase shift or intensity decay of the reflected light to determine distance for each pixel (e.g., Microsoft Azure Kinect, Intel RealSense L515).</p>
</li>
<li class="">
<p><strong>Physical Context</strong>: Depth cameras are sensitive to ambient light, particularly infrared interference. Shiny or transparent surfaces pose significant challenges. Processing stereo or structured light patterns into depth maps requires computational power, typically on the robot&#x27;s CPU or a dedicated ISP, directly impacting the frame rate and latency. Thermal throttling on edge devices (Jetson Orin) can reduce effective frame rates significantly.</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-raw-data-scans-vs-images">The Raw Data: Scans vs. Images<a href="#the-raw-data-scans-vs-images" class="hash-link" aria-label="Direct link to The Raw Data: Scans vs. Images" title="Direct link to The Raw Data: Scans vs. Images" translate="no">‚Äã</a></h4>
<ul>
<li class=""><strong>LiDAR</strong>: Typically outputs <code>sensor_msgs/msg/LaserScan</code> for 2D lidars (a sweep of distances) or <code>sensor_msgs/msg/PointCloud2</code> directly for 3D lidars. The data is inherently 3D points.</li>
<li class=""><strong>Depth Cameras</strong>: Usually provide <code>sensor_msgs/msg/Image</code> messages, where each pixel&#x27;s intensity represents depth (e.g., in millimeters). A separate step is required to convert this 2D depth image into a 3D point cloud using the camera&#x27;s intrinsic parameters.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="Ô∏è-architecture-point-cloud-processing-pipeline">üõ†Ô∏è Architecture: Point Cloud Processing Pipeline<a href="#Ô∏è-architecture-point-cloud-processing-pipeline" class="hash-link" aria-label="Direct link to üõ†Ô∏è Architecture: Point Cloud Processing Pipeline" title="Direct link to üõ†Ô∏è Architecture: Point Cloud Processing Pipeline" translate="no">‚Äã</a></h3>
<p>This chapter focuses on converting a 2D depth image into a 3D <code>PointCloud2</code> message. The basic architecture involves a camera node publishing depth images, which are then subscribed to and processed by our custom point cloud converter node, and finally visualized in <code>RViz2</code>.</p>
<!-- -->
<p><strong>ROS 2 Topics and Messages:</strong></p>
<ul>
<li class=""><code>/camera/depth/image_raw</code>: A <code>sensor_msgs/msg/Image</code> message containing the 2D depth map. Each pixel&#x27;s value represents distance.</li>
<li class=""><code>/camera/camer-info</code>: A <code>sensor_msgs/msg/CameraInfo</code> message providing the camera&#x27;s intrinsic parameters (focal lengths, principal point) and distortion model, essential for projecting 2D pixels into 3D space.</li>
<li class=""><code>/camera/depth/points</code>: Our output <code>sensor_msgs/msg/PointCloud2</code> message, containing the X, Y, Z coordinates for each point, and optionally RGB data if available.</li>
</ul>
<p><strong>QoS Considerations:</strong>
For point cloud data, Quality of Service (QoS) settings are critical for balancing latency and reliability, especially on resource-constrained edge devices.</p>
<ul>
<li class=""><strong>Depth Image Subscription (<code>/camera/depth/image_raw</code>)</strong>:<!-- -->
<ul>
<li class=""><strong>Reliability</strong>: <code>Best Effort</code> is often preferred for high-frequency sensor data like depth images. If a packet is occasionally dropped, a newer frame will quickly arrive, minimizing latency. <code>Reliable</code> would retransmit lost packets, potentially increasing latency for real-time applications.</li>
<li class=""><strong>Durability</strong>: <code>Volatile</code> (default) is suitable as we only care about the most recent frame.</li>
<li class=""><strong>History</strong>: <code>Keep Last</code> with a depth of 1-5 to ensure we always get a recent frame.</li>
</ul>
</li>
<li class=""><strong>Point Cloud Publication (<code>/camera/depth/points</code>)</strong>:<!-- -->
<ul>
<li class="">Similar to the subscription, <code>Best Effort</code> is usually appropriate to prioritize fresh data over guaranteed delivery.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-implementation-depth-image-to-point-cloud-conversion">üíª Implementation: Depth Image to Point Cloud Conversion<a href="#-implementation-depth-image-to-point-cloud-conversion" class="hash-link" aria-label="Direct link to üíª Implementation: Depth Image to Point Cloud Conversion" title="Direct link to üíª Implementation: Depth Image to Point Cloud Conversion" translate="no">‚Äã</a></h3>
<p>This ROS 2 Python node will subscribe to a depth image and camera info, then convert the 2D depth data into a 3D point cloud, publishing it as a <code>sensor_msgs/msg/PointCloud2</code> message.</p>
<p><strong>Context</strong>: This file should live in your ROS 2 workspace, for example, <code>~/ros2_ws/src/my_robot_perception/my_robot_perception/depth_to_pointcloud_node.py</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> rclpy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">node </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sensor_msgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CameraInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PointCloud2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PointField</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> std_msgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cv2 </span><span class="token comment" style="color:#999988;font-style:italic"># For cv_bridge, though manual conversion is shown for clarity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Ensure &#x27;my_robot_perception&#x27; is defined as an entry point in setup.py:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setup(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#     # ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#     entry_points={</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#         &#x27;console_scripts&#x27;: [</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#             &#x27;depth_to_pointcloud = my_robot_perception.depth_to_pointcloud_node:main&#x27;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#         ],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#     },</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DepthToPointCloudNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;depth_to_pointcloud_node&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_logger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DepthToPointCloudNode has been started.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># --- QoS Profile for Sensor Data ---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Prioritize fresh data over guaranteed delivery for high-frequency sensor streams</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qos_profile_sensor_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qos_profile_sensor_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># For publishing, a simple default with Best Effort is usually fine if we don&#x27;t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># need guaranteed reception, which is typical for point clouds in real-time.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qos_profile_point_cloud </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qos_profile_system_default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qos_profile_point_cloud</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reliability </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">QoSReliabilityPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BEST_EFFORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image_sub </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_subscription</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;/camera/depth/image_raw&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            qos_profile_sensor_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_info_sub </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_subscription</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CameraInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;/camera/camer-info&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_info_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            qos_profile_sensor_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">point_cloud_pub </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_publisher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PointCloud2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;/camera/depth/points&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            qos_profile_point_cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">camer_info_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Store camera intrinsics (fx, fy, cx, cy) from CameraInfo message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            K </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k </span><span class="token comment" style="color:#999988;font-style:italic"># Intrinsic camera matrix: [fx 0 cx; 0 fy cy; 0 0 1]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&#x27;fx&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;fy&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&#x27;cx&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cy&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_logger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Camera intrinsics received: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">camer_intrinsics</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Resolution: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">image_width</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">x</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">image_height</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Only process once, or update if dimensions change (uncommon for fixed cameras)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">depth_image_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process_depth_to_pointcloud</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">process_depth_to_pointcloud</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Convert ROS Image message to an OpenCV (numpy) array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Assuming the depth image is 16-bit unsigned integer (mm) or 32-bit float (m)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use cv_bridge in a real application, but showing manual numpy conversion for didactic purposes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># For simplicity, let&#x27;s assume 16UC1 (16-bit unsigned, 1 channel) for depth in millimeters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># If msg.encoding is &#x27;16UC1&#x27;, values are depth in millimeters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># If msg.encoding is &#x27;32FC1&#x27;, values are depth in meters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># NOTE: In a production ROS 2 environment, use the `cv_bridge` package</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># to safely convert ROS Image messages to OpenCV numpy arrays.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Example with cv_bridge:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># from cv_bridge import CvBridge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># self.bridge = CvBridge()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># cv_image = self.bridge.imgmsg_to_cv2(self.depth_image, desired_encoding=&quot;passthrough&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Manual conversion for 16UC1 (assuming little-endian for simplicity)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encoding </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;16UC1&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            depth_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frombuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uint16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            depth_scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.001</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Convert mm to meters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encoding </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;32FC1&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            depth_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frombuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            depth_scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Already in meters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_logger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Unsupported depth image encoding: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">depth_image</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">encoding</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get camera intrinsics</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;fx&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;fy&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cx&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">camer_intrinsics</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cy&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        points </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_height</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> u </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">image_width</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> depth_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> depth_scale </span><span class="token comment" style="color:#999988;font-style:italic"># Depth in meters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Filter out invalid depth values (0 or too large/small, depending on sensor)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Physical Context: Real sensors have minimum and maximum ranges.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># 0 often means no valid depth measurement.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Example range: 0.1m to 10m</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Convert 2D pixel (u, v) and depth Z to 3D point (X, Y, Z)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                X </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> cx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> fx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> cy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> fy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                points</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> points</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_logger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;No valid points generated from depth image.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Convert list of points to a NumPy array for easier processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        points_np </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">points</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Create PointCloud2 message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PointCloud2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depth_image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_id </span><span class="token comment" style="color:#999988;font-style:italic"># Important for TF!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Unordered point cloud</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">points</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Number of points</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Define fields for X, Y, Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fields </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PointField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;x&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> datatype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PointField</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FLOAT32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PointField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;y&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> datatype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PointField</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FLOAT32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PointField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;z&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> datatype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PointField</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FLOAT32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_bigendian </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Most systems are little-endian</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">point_step </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 3 floats * 4 bytes/float = 12 bytes per point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row_step </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">point_step </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_dense </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># No invalid (NaN) points, as we filtered them</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Pack points into the data buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point_cloud_msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> points_np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tobytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">point_cloud_pub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point_cloud_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># self.get_logger().info(f&quot;Published point cloud with {len(points)} points.&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DepthToPointCloudNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">spin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">destroy_node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rclpy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shutdown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;__main__&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="Ô∏è-common-pitfalls-sim-vs-real">‚ö†Ô∏è Common Pitfalls (Sim vs. Real)<a href="#Ô∏è-common-pitfalls-sim-vs-real" class="hash-link" aria-label="Direct link to ‚ö†Ô∏è Common Pitfalls (Sim vs. Real)" title="Direct link to ‚ö†Ô∏è Common Pitfalls (Sim vs. Real)" translate="no">‚Äã</a></h3>
<ul>
<li class=""><strong>Simulation</strong>:<!-- -->
<ul>
<li class=""><strong>What works</strong>: In simulators like Isaac Sim or Gazebo, depth images are often perfect, with no noise, infinite range (within reasonable bounds), and ideal reflections. Camera intrinsics are precisely known and stable.</li>
<li class=""><strong>Why this matters</strong>: Code developed in simulation might over-rely on this pristine data, leading to brittle algorithms.</li>
</ul>
</li>
<li class=""><strong>Reality</strong>:<!-- -->
<ul>
<li class=""><strong>What fails</strong>:<!-- -->
<ul>
<li class=""><strong>Sensor Noise</strong>: Real depth cameras are inherently noisy. Values can fluctuate even for static scenes. This leads to &quot;fuzzy&quot; point clouds.</li>
<li class=""><strong>Reflections and Absorption</strong>: Transparent (glass) or highly reflective (polished metal) surfaces cause depth sensors to fail or return incorrect values. Dark, absorptive surfaces also pose challenges. This manifests as &quot;holes&quot; or erroneous points.</li>
<li class=""><strong>Limited Range and Field of View</strong>: Every sensor has physical limitations. Objects too close, too far, or outside the FoV will not be detected.</li>
<li class=""><strong>Ambient Light Interference</strong>: Structured light and ToF cameras can be affected by strong sunlight or other infrared sources.</li>
<li class=""><strong>Calibration Errors</strong>: Imperfect camera calibration (intrinsics and extrinsics) will lead to inaccuracies in point cloud generation and transformation.</li>
<li class=""><strong>Thermal Throttling (Edge Devices)</strong>: On Jetson Orin Nano, continuous high-frequency depth image processing can cause the GPU/CPU to overheat and throttle, reducing frame rates and increasing processing latency. This directly impacts real-time control.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Fix</strong>:<!-- -->
<ul>
<li class=""><strong>Filtering</strong>: Implement noise reduction (e.g., statistical outlier removal, voxel grid downsampling) using PCL.</li>
<li class=""><strong>Robust Algorithms</strong>: Design algorithms (e.g., for object detection, SLAM) that can handle sparse, noisy, or incomplete point cloud data.</li>
<li class=""><strong>Environmental Control</strong>: Where possible, minimize challenging surfaces or control lighting.</li>
<li class=""><strong>Careful Calibration</strong>: Use standard calibration tools (ee.g., <code>ros2 run camera_calibration cameracalibrator.py</code>) to obtain accurate camera intrinsics.</li>
<li class=""><strong>Resource Monitoring</strong>: Monitor CPU/GPU usage and temperature on edge devices. Optimize point cloud processing (e.g., by downsampling, reducing resolution) to stay within thermal limits. Consider using C++ for performance-critical components.</li>
<li class=""><strong>QoS</strong>: Use <code>Best Effort</code> for sensor data to prioritize fresh data, accepting occasional drops to maintain low latency on resource-constrained hardware.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-verification">üß™ Verification<a href="#-verification" class="hash-link" aria-label="Direct link to üß™ Verification" title="Direct link to üß™ Verification" translate="no">‚Äã</a></h3>
<p>After building and installing your <code>my_robot_perception</code> package, launch a depth camera (e.g., RealSense D435) in ROS 2, and then run your node.</p>
<ol>
<li class=""><strong>Launch a depth camera (example with Intel RealSense):</strong>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch realsense2_camera rs_launch.py align_depth.enable:=true</span><br></span></code></pre></div></div>
<!-- -->This should publish <code>/camera/depth/image_raw</code> and <code>/camera/camer-info</code>.</li>
<li class=""><strong>Run your depth-to-pointcloud node:</strong>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 run my_robot_perception depth_to_pointcloud</span><br></span></code></pre></div></div>
</li>
<li class=""><strong>Verify the published point cloud topic:</strong>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 topic list | grep /camera/depth/points</span><br></span></code></pre></div></div>
<!-- -->You should see <code>/camera/depth/points</code>.</li>
<li class=""><strong>Echo the point cloud message (observe headers, not full data):</strong>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 topic echo /camera/depth/points --no-arr --once</span><br></span></code></pre></div></div>
<!-- -->This will show the message structure, header, and the number of points without printing all the raw point data, which can be very large. Check <code>header.frame_id</code> and <code>header.stamp</code>.</li>
<li class=""><strong>Visualize the point cloud in RViz2:</strong>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rviz2</span><br></span></code></pre></div></div>
<ul>
<li class="">In RViz2, add a &quot;By Topic&quot; display, select <code>/camera/depth/points</code>.</li>
<li class="">Set the &quot;Fixed Frame&quot; to the <code>frame_id</code> reported by your <code>/camera/depth/points</code> message (e.g., <code>camera_link</code> or <code>camera_depth_optical_frame</code>).</li>
<li class="">You should now see the 3D point cloud rendered in RViz2. Adjust the size and color for better visualization.</li>
<li class=""><strong>Crucial check</strong>: Move an object in front of the depth camera. The point cloud in RViz2 should update in real-time, accurately reflecting the object&#x27;s position and shape. If the point cloud appears distorted or static, troubleshoot your camera info or depth image processing.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-chapter-summary">üìù Chapter Summary<a href="#-chapter-summary" class="hash-link" aria-label="Direct link to üìù Chapter Summary" title="Direct link to üìù Chapter Summary" translate="no">‚Äã</a></h3>
<ul>
<li class=""><strong>3D Perception</strong> is essential for navigating complex environments; 2D images are not enough.</li>
<li class=""><strong>LiDAR</strong> provides precise, sparse distance measurements using lasers.</li>
<li class=""><strong>Depth Cameras</strong> use techniques like structured light or stereo vision to generate dense depth maps.</li>
<li class=""><strong>ROS 2</strong> represents 3D data as <code>PointCloud2</code> messages, which can be visualized in RViz.</li>
<li class=""><strong>Real-world issues</strong> like reflective surfaces, sensor noise, and thermal limits on edge devices must be managed with filtering and efficient code.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-conclusion">üîö Conclusion<a href="#-conclusion" class="hash-link" aria-label="Direct link to üîö Conclusion" title="Direct link to üîö Conclusion" translate="no">‚Äã</a></h3>
<p>With 3D perception, our robot can now understand the shape and structure of its environment. It knows not just that there is an object, but how far away it is and its dimensions. However, a robot rarely relies on a single sensor. To build a truly robust picture of reality, we must combine data from multiple sources‚Äîcameras, LiDAR, and IMUs. In the next chapter, we will explore Sensor Fusion, the art of merging these disparate streams into a single, coherent truth.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/EngineerAbdullahIqbal/roboailearner/tree/main/robotics_book_content/docs/module-2/chapter-5.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/roboailearner/docs/module-2/chapter-4"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 4: Camera Systems and Image Processing in ROS 2</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/roboailearner/docs/module-2/chapter-6"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 6: Sensor Fusion: Combining Data for Robust Perception</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-objective" class="table-of-contents__link toc-highlight">üéØ Objective</a></li><li><a href="#-theory-how-lidar-and-depth-cameras-see-the-world" class="table-of-contents__link toc-highlight">üß† Theory: How Lidar and Depth Cameras See the World</a></li><li><a href="#Ô∏è-architecture-point-cloud-processing-pipeline" class="table-of-contents__link toc-highlight">üõ†Ô∏è Architecture: Point Cloud Processing Pipeline</a></li><li><a href="#-implementation-depth-image-to-point-cloud-conversion" class="table-of-contents__link toc-highlight">üíª Implementation: Depth Image to Point Cloud Conversion</a></li><li><a href="#Ô∏è-common-pitfalls-sim-vs-real" class="table-of-contents__link toc-highlight">‚ö†Ô∏è Common Pitfalls (Sim vs. Real)</a></li><li><a href="#-verification" class="table-of-contents__link toc-highlight">üß™ Verification</a></li><li><a href="#-chapter-summary" class="table-of-contents__link toc-highlight">üìù Chapter Summary</a></li><li><a href="#-conclusion" class="table-of-contents__link toc-highlight">üîö Conclusion</a></li></ul></div></div></div></div></main></div></div></div><button style="position:fixed;bottom:20px;right:20px;background-color:var(--ifm-color-primary);color:white;border:none;border-radius:50%;width:60px;height:60px;font-size:30px;cursor:pointer;box-shadow:0 4px 12px rgba(0, 0, 0, 0.2);z-index:1001;display:flex;align-items:center;justify-content:center">üí¨ </button></div>
</body>
</html>